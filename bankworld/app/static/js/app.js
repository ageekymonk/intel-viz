// Generated by CoffeeScript 1.7.1
(function() {
  'use strict';
  var BWDashboard, BWMap, BWMapVirus, BWReportMap, DifferenceChart, MultiLineChart, MultiTimeSeriesPolicyChart, ServerConnectionsChart, WsConnectionsChart, b,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  BWMap = (function() {
    function BWMap(width, height, parent, evDispatch) {
      if (width == null) {
        width = 400;
      }
      if (height == null) {
        height = 300;
      }
      if (parent == null) {
        parent = "body";
      }
      this.width = width;
      this.height = height;
      this.parent = parent;
      this.evDispatch = evDispatch;
      this.projection = d3.geo.equirectangular();
      this.svg = d3.select(parent).append("svg").attr({
        width: this.width,
        height: this.height
      });
      this.coord = null;
      this.datareport = null;
    }

    BWMap.prototype.load = function() {
      return d3.csv('/static/csv/branch_lat_long.csv').get((function(_this) {
        return function(error, world) {
          var dateFormat;
          world.forEach(function(d) {
            var _ref, _ref1;
            _ref = _this.projection([d.minlong, d.maxlat]), d.x1 = _ref[0], d.y1 = _ref[1];
            _ref1 = _this.projection([d.maxlong, d.minlat]), d.x2 = _ref1[0], d.y2 = _ref1[1];
            d.width = (d.x2 - d.x1) === 0 ? 5 : d.x2 - d.x1;
            return d.height = (d.y2 - d.y1) === 0 ? 5 : d.y2 - d.y1;
          });
          dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
          _this.coord = world;
          return d3.csv('/static/csv/ws_report_status.csv').get(function(error, datareport) {
            _this.datareport = datareport;
            datareport.forEach(function(d) {
              dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
              return d.timestamp = dateFormat.parse(d.healthtime);
            });
            return _this.evDispatch.attime(dateFormat.parse("2012-02-02 14:00:00"));
          });
        };
      })(this));
    };

    BWMap.prototype.draw = function(time) {
      var report;
      this.svg.remove();
      this.svg = d3.select(this.parent).append("svg").attr({
        width: this.width,
        height: this.height
      });
      this.svg.append("svg:image").attr("xlink:href", "/static/images/BankWorld-binary.png").attr("x", "0").attr("y", "0").attr("width", this.width).attr("height", this.height);
      this.svg.insert("path", ".graticule").attr("class", "boundary").attr("d", "").attr('fill', "url(#img1)");
      this.svg.selectAll(".area").data(this.coord).enter().append("circle", ".area").attr({
        cx: function(d) {
          return d.x1;
        },
        cy: function(d) {
          return d.y1;
        },
        r: function(d) {
          return 0;
        },
        id: function(d) {
          return "bu_" + d.businessunit;
        }
      }).style("stroke", "black").attr({
        "fill": "red",
        "fill-opacity": .8
      }).on("click", (function(_this) {
        return function(d) {
          return _this.evDispatch.selectRegion(d.businessunit);
        };
      })(this));
      this.svg.selectAll('circle').on("mouseover.tooltip", (function(_this) {
        return function(d) {
          _this.svg.select('#data_id').remove();
          return _this.svg.append('text').text(d.businessunit).attr('x', d.x1).attr('y', d.y1).attr('id', 'data_id');
        };
      })(this));
      this.svg.selectAll('circle').on("mouseout.tooltip", (function(_this) {
        return function(d) {
          return _this.svg.select('#data_id').transition().duration(20).style('opacity', 0).attr('transform', 'translate(10,-10)').remove();
        };
      })(this));
      report = this.datareport.filter((function(_this) {
        return function(d) {
          return +d.timestamp === +time;
        };
      })(this));
      report.forEach((function(_this) {
        return function(d) {
          if (d.businessunit === 'datacenter-5') {
            console.log(d);
          }
          if (((+d.expected - +d.reported) / +d.expected) * 100 >= 10) {
            return _this.svg.select("#bu_" + d.businessunit).attr({
              r: ((+d.expected - +d.reported) / +d.expected) * 10
            });
          }
        };
      })(this));
      return d3.select(self.frameElement).style("height", this.height + "px");
    };

    return BWMap;

  })();

  BWMapVirus = (function() {
    function BWMapVirus(width, height, parent, evDispatch) {
      if (width == null) {
        width = 400;
      }
      if (height == null) {
        height = 300;
      }
      if (parent == null) {
        parent = "body";
      }
      this.width = width;
      this.height = height;
      this.parent = parent;
      this.evDispatch = evDispatch;
      this.projection = d3.geo.equirectangular();
      this.svg = d3.select(parent).append("svg").attr({
        width: this.width,
        height: this.height
      });
      this.coord = null;
      this.datareport = null;
    }

    BWMapVirus.prototype.load = function() {
      return d3.csv('/static/csv/branch_lat_long.csv').get((function(_this) {
        return function(error, world) {
          var dateFormat;
          world.forEach(function(d) {
            var _ref, _ref1;
            _ref = _this.projection([d.minlong, d.maxlat]), d.x1 = _ref[0], d.y1 = _ref[1];
            _ref1 = _this.projection([d.maxlong, d.minlat]), d.x2 = _ref1[0], d.y2 = _ref1[1];
            d.width = (d.x2 - d.x1) === 0 ? 5 : d.x2 - d.x1;
            return d.height = (d.y2 - d.y1) === 0 ? 5 : d.y2 - d.y1;
          });
          dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
          _this.coord = world;
          return d3.csv('/static/csv/policy5_status.csv').get(function(error, datareport) {
            _this.datareport = datareport;
            datareport.forEach(function(d) {
              dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
              return d.timestamp = dateFormat.parse(d.healthtime);
            });
            return _this.evDispatch.attime(dateFormat.parse("2012-02-02 14:00:00"));
          });
        };
      })(this));
    };

    BWMapVirus.prototype.draw = function(time) {
      var report;
      this.svg.remove();
      this.svg = d3.select(this.parent).append("svg").attr({
        width: this.width,
        height: this.height
      });
      this.svg.append("svg:image").attr("xlink:href", "/static/images/BankWorld-binary.png").attr("x", "0").attr("y", "0").attr("width", this.width).attr("height", this.height);
      this.svg.insert("path", ".graticule").attr("class", "boundary").attr("d", "").attr('fill', "url(#img1)");
      this.svg.selectAll(".area").data(this.coord).enter().append("circle", ".area").attr({
        cx: function(d) {
          return d.x1;
        },
        cy: function(d) {
          return d.y1;
        },
        r: function(d) {
          return 0;
        },
        id: function(d) {
          return "bu_virus_" + d.businessunit;
        }
      }).style("stroke", "black").attr({
        "fill": "red",
        "fill-opacity": .8
      }).on("click", (function(_this) {
        return function(d) {
          return _this.evDispatch.selectRegion(d.businessunit);
        };
      })(this));
      this.svg.selectAll('circle').on("mouseover.tooltip", (function(_this) {
        return function(d) {
          _this.svg.select('#spread_data_id').remove();
          return _this.svg.append('text').text(d.businessunit).attr('x', d.x1).attr('y', d.y1).attr('id', 'spread_data_id').attr({
            stroke: 'blue',
            'stroke-width': '0.5'
          });
        };
      })(this));
      this.svg.selectAll('circle').on("mouseout.tooltip", (function(_this) {
        return function(d) {
          return _this.svg.select('#spread_data_id').transition().duration(20).style('opacity', 0).attr('transform', 'translate(10,-10)').remove();
        };
      })(this));
      report = this.datareport.filter((function(_this) {
        return function(d) {
          return +d.timestamp === +time;
        };
      })(this));
      report.forEach((function(_this) {
        return function(d) {
          return _this.svg.select("#bu_virus_" + d.businessunit).attr({
            r: function(x) {
              return 3 + (+d.numipaddr / 40);
            }
          });
        };
      })(this));
      return d3.select(self.frameElement).style("height", this.height + "px");
    };

    return BWMapVirus;

  })();

  BWReportMap = (function() {
    function BWReportMap(width, height, parent, evDispatch) {
      if (width == null) {
        width = 400;
      }
      if (height == null) {
        height = 300;
      }
      if (parent == null) {
        parent = "body";
      }
      this.width = width;
      this.height = height;
      this.evDispatch = evDispatch;
      this.projection = d3.geo.equirectangular();
      this.svg = d3.select(parent).append("svg").attr({
        width: this.width,
        height: this.height
      });
    }

    BWReportMap.prototype.draw = function() {
      return d3.csv('/static/csv/branch_lat_long.csv').get((function(_this) {
        return function(error, world) {
          world.forEach(function(d) {
            var _ref, _ref1;
            _ref = _this.projection([d.minlong, d.maxlat]), d.x1 = _ref[0], d.y1 = _ref[1];
            _ref1 = _this.projection([d.maxlong, d.minlat]), d.x2 = _ref1[0], d.y2 = _ref1[1];
            d.width = (d.x2 - d.x1) === 0 ? 5 : d.x2 - d.x1;
            return d.height = (d.y2 - d.y1) === 0 ? 5 : d.y2 - d.y1;
          });
          _this.svg.selectAll(".area").data(world).enter().append("rect", ".area").attr({
            x: function(d) {
              return d.x1;
            },
            y: function(d) {
              return d.y1;
            },
            width: function(d) {
              return d.width;
            },
            height: function(d) {
              return d.height;
            },
            id: function(d) {
              return "bu_" + d.businessunit;
            }
          }).style("stroke", "black").attr("fill", "white").on("click", function(d) {
            return _this.evDispatch.selectRegion(d.businessunit);
          });
          _this.svg.selectAll('rect').on("mouseover.tooltip", function(d) {
            _this.svg.select('#data_id').remove();
            return _this.svg.append('text').text(d.businessunit).attr('x', d.x1).attr('y', d.y1).attr('id', 'data_id');
          });
          _this.svg.selectAll('rect').on("mouseout.tooltip", function(d) {
            return _this.svg.select('#data_id').transition().duration(20).style('opacity', 0).attr('transform', 'translate(10,-10)').remove();
          });
          return d3.select(self.frameElement).style("height", _this.height + "px");
        };
      })(this));
    };

    return BWReportMap;

  })();

  MultiTimeSeriesPolicyChart = (function() {
    function MultiTimeSeriesPolicyChart(w, h, parent, title, evDispatch) {
      if (parent == null) {
        parent = "body";
      }
      if (title == null) {
        title = "";
      }
      this.margin = {
        top: 20,
        right: 60,
        bottom: 50,
        left: 60
      };
      this.width = w - this.margin.left - this.margin.right;
      this.height = h - this.margin.top - this.margin.bottom;
      this.parent = parent;
      this.allbudata = null;
      this.title = title;
      this.evDispatch = evDispatch;
      this.curregion = "headquarters";
      this.policystatus = ['p4', 'p5'];
    }

    MultiTimeSeriesPolicyChart.prototype.load = function(data) {
      var dateFormat;
      this.allbudata = data;
      dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
      return this.allbudata.forEach(function(d) {
        return d.timestamp = dateFormat.parse(d.healthtime);
      });
    };

    MultiTimeSeriesPolicyChart.prototype.draw = function(region) {
      var button, canvas, color_scale, data, svg, x, xAxis, y, yAxis;
      if (region == null) {
        region = "headquarters";
      }
      this.curregion = region;
      color_scale = d3.scale.category10().domain(["p1", "p2", "p3", "p4", "p5", "a1", "a2", "a3", "a4", "a5"]);
      button = d3.select(this.parent).selectAll("button").data(["p1", "p2", "p3", "p4", "p5", "a1", "a2", "a3", "a4", "a5"]).enter().append('button').attr("type", "button").attr({
        "class": "btn btn-xs",
        id: function(d) {
          return d;
        }
      }).style('background-color', function(d) {
        return color_scale(d);
      }).text(function(d) {
        return d;
      });
      button.on("click", (function(_this) {
        return function(d) {
          if (__indexOf.call(_this.policystatus, d) < 0) {
            _this.policystatus.push(d);
          } else {
            _this.policystatus = _this.policystatus.filter(function(val) {
              return d !== val;
            });
          }
          return _this.draw(_this.curregion);
        };
      })(this));
      data = this.allbudata.filter((function(_this) {
        return function(d) {
          return d.businessunit === region;
        };
      })(this));
      d3.select(this.parent).selectAll("svg").remove();
      canvas = d3.select(this.parent).append('svg').attr({
        width: this.width + this.margin.left + this.margin.right,
        height: this.height + this.margin.top + this.margin.bottom
      });
      svg = canvas.append('g').attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");
      x = d3.time.scale().range([0, this.width]);
      x.domain(d3.extent(data, function(d) {
        return d.timestamp;
      }));
      y = d3.scale.linear().range([this.height, 0]);
      y.domain([
        d3.min(data, (function(_this) {
          return function(d) {
            var s;
            return d3.min((function() {
              var _i, _len, _ref, _results;
              _ref = this.policystatus;
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                s = _ref[_i];
                _results.push(+d[s]);
              }
              return _results;
            }).call(_this));
          };
        })(this)), d3.max(data, (function(_this) {
          return function(d) {
            var s;
            return d3.max((function() {
              var _i, _len, _ref, _results;
              _ref = this.policystatus;
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                s = _ref[_i];
                _results.push(+d[s]);
              }
              return _results;
            }).call(_this));
          };
        })(this))
      ]);
      xAxis = d3.svg.axis().scale(x).orient("bottom");
      yAxis = d3.svg.axis().scale(y).orient("left");
      color_scale = d3.scale.category10().domain(["p1", "p2", "p3", "p4", "p5", "a1", "a2", "a3", "a4", "a5"]);
      this.policystatus.forEach((function(_this) {
        return function(policystatus) {
          return svg.append("path").datum(data).attr("class", "line").attr({
            d: d3.svg.line().x(function(d) {
              return x(d.timestamp);
            }).y(function(d) {
              return y(+d[policystatus]);
            }),
            stroke: color_scale(policystatus)
          });
        };
      })(this));
      svg.append('rect').attr({
        "class": 'overlay',
        width: this.width + this.margin.left + this.margin.right,
        height: this.height + this.margin.top + this.margin.bottom,
        fill: 'none',
        'pointer-events': 'all'
      });
      svg.on("mousemove", (function(_this) {
        return function() {
          var bisectDate, d, d0, d1, data_list, i, num_policy_in_text, tootltip_box, x0;
          x0 = x.invert(d3.mouse(d3.event.target)[0]);
          bisectDate = d3.bisector(function(d) {
            return d.timestamp;
          }).left;
          i = bisectDate(data, x0, 1);
          d0 = data[i - 1];
          d1 = data[i];
          d = x0 - d0.date > d1.date - x0 ? d1 : d0;
          data_list = data.filter(function(d) {
            return d.timestamp === d0.timestamp;
          });
          svg.select('#policystatus_tooltip_line').remove();
          svg.append('line').attr({
            x1: x(d.timestamp),
            y1: 0,
            x2: x(d.timestamp),
            y2: _this.height,
            stroke: 'green',
            'stroke-width': 2,
            id: 'policystatus_tooltip_line'
          });
          svg.select('#policystatus_data_id').remove();
          tootltip_box = svg.append('g').attr('id', 'policystatus_data_id');
          tootltip_box.append('text').text(d['healthtime']).attr('x', x(d.timestamp) + 10).attr('y', 30).attr('stroke', 'green').attr('stroke-width', 0.5);
          num_policy_in_text = 1;
          return _this.policystatus.forEach(function(policystatus) {
            tootltip_box.append('text').text("" + policystatus + ": " + d[policystatus]).attr('x', x(d.timestamp) + 10).attr('y', 30 + num_policy_in_text * 10).attr('stroke', 'green').attr('stroke-width', 0.5);
            return num_policy_in_text = num_policy_in_text + 1;
          });
        };
      })(this));
      svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + this.height + ")").call(xAxis);
      svg.append("g").attr("class", "y axis").call(yAxis);
      canvas.append("text").attr("transform", "translate(0,30) rotate(-90)").attr("y", 10).attr("dy", ".71em").style("text-anchor", "end").text("Machine Count");
      return svg.append("text").attr("x", this.width / 2).attr("y", 0 - (this.margin.top / 2)).attr("text-anchor", "middle").attr("class", "chart-title").text(this.curregion);
    };

    return MultiTimeSeriesPolicyChart;

  })();

  WsConnectionsChart = (function() {
    function WsConnectionsChart(w, h, parent, title, evDispatch) {
      if (parent == null) {
        parent = "body";
      }
      if (title == null) {
        title = "";
      }
      this.margin = {
        top: 20,
        right: 60,
        bottom: 50,
        left: 60
      };
      this.width = w - this.margin.left - this.margin.right;
      this.height = h - this.margin.top - this.margin.bottom;
      this.parent = parent;
      this.allbudata = null;
      this.title = title;
      this.evDispatch = evDispatch;
      this.curregion = "headquarters";
      this.policystatus = ["teller", "loan", "office"];
    }

    WsConnectionsChart.prototype.load = function(data) {
      var dateFormat;
      this.allbudata = data;
      dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
      return this.allbudata.forEach(function(d) {
        return d.timestamp = dateFormat.parse(d.healthtime);
      });
    };

    WsConnectionsChart.prototype.draw = function(region) {
      var button, canvas, color_scale, data, svg, x, xAxis, y, yAxis;
      if (region == null) {
        region = "headquarters";
      }
      this.curregion = region;
      color_scale = d3.scale.category10().domain(["teller", "loan", "office"]);
      button = d3.select(this.parent).selectAll("button").data(["teller", "loan", "office"]).enter().append('button').attr("type", "button").attr({
        "class": "btn btn-xs",
        id: function(d) {
          return d;
        }
      }).style('background-color', function(d) {
        return color_scale(d);
      }).text(function(d) {
        return d;
      });
      button.on("click", (function(_this) {
        return function(d) {
          if (__indexOf.call(_this.policystatus, d) < 0) {
            _this.policystatus.push(d);
          } else {
            _this.policystatus = _this.policystatus.filter(function(val) {
              return d !== val;
            });
          }
          return _this.draw(_this.curregion);
        };
      })(this));
      data = this.allbudata.filter((function(_this) {
        return function(d) {
          return d.businessunit === region;
        };
      })(this));
      d3.select(this.parent).selectAll("svg").remove();
      canvas = d3.select(this.parent).append('svg').attr({
        width: this.width + this.margin.left + this.margin.right,
        height: this.height + this.margin.top + this.margin.bottom
      });
      svg = canvas.append('g').attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");
      x = d3.time.scale().range([0, this.width]);
      x.domain(d3.extent(data, function(d) {
        return d.timestamp;
      }));
      y = d3.scale.linear().range([this.height, 0]);
      y.domain([
        d3.min(data, (function(_this) {
          return function(d) {
            var s;
            return d3.min((function() {
              var _i, _len, _ref, _results;
              _ref = this.policystatus;
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                s = _ref[_i];
                _results.push(+d["" + s + "_avg_conn"]);
              }
              return _results;
            }).call(_this));
          };
        })(this)), d3.max(data, (function(_this) {
          return function(d) {
            var s;
            return d3.max((function() {
              var _i, _len, _ref, _results;
              _ref = this.policystatus;
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                s = _ref[_i];
                _results.push(+d["" + s + "_avg_conn"]);
              }
              return _results;
            }).call(_this));
          };
        })(this))
      ]);
      xAxis = d3.svg.axis().scale(x).orient("bottom");
      yAxis = d3.svg.axis().scale(y).orient("left");
      color_scale = d3.scale.category10().domain(["teller", "loan", "office"]);
      this.policystatus.forEach((function(_this) {
        return function(policystatus) {
          return svg.append("path").datum(data).attr("class", "line").attr({
            d: d3.svg.line().x(function(d) {
              return x(d.timestamp);
            }).y(function(d) {
              return y(+d["" + policystatus + "_avg_conn"]);
            }),
            stroke: color_scale(policystatus)
          });
        };
      })(this));
      svg.append('rect').attr({
        "class": 'overlay',
        width: this.width + this.margin.left + this.margin.right,
        height: this.height + this.margin.top + this.margin.bottom,
        fill: 'none',
        'pointer-events': 'all'
      });
      svg.on("mousemove", (function(_this) {
        return function() {
          var bisectDate, d, d0, d1, data_list, i, num_policy_in_text, tootltip_box, x0;
          x0 = x.invert(d3.mouse(d3.event.target)[0]);
          bisectDate = d3.bisector(function(d) {
            return d.timestamp;
          }).left;
          i = bisectDate(data, x0, 1);
          d0 = data[i - 1];
          d1 = data[i];
          d = x0 - d0.date > d1.date - x0 ? d1 : d0;
          data_list = data.filter(function(d) {
            return d.timestamp === d0.timestamp;
          });
          svg.select('#ws_conn_tooltip_line').remove();
          svg.append('line').attr({
            x1: x(d.timestamp),
            y1: 0,
            x2: x(d.timestamp),
            y2: _this.height,
            stroke: 'green',
            'stroke-width': 2,
            id: 'ws_conn_tooltip_line'
          });
          svg.select('#ws_conn_data_id').remove();
          tootltip_box = svg.append('g').attr('id', 'ws_conn_data_id');
          tootltip_box.append('text').text(d['healthtime']).attr('x', x(d.timestamp) + 10).attr('y', 30).attr('stroke', 'green').attr('stroke-width', 0.5);
          num_policy_in_text = 1;
          return _this.policystatus.forEach(function(policystatus) {
            tootltip_box.append('text').text("" + policystatus + ": " + d[policystatus + '_avg_conn']).attr('x', x(d.timestamp) + 10).attr('y', 30 + num_policy_in_text * 10).attr('stroke', 'green').attr('stroke-width', 0.5);
            return num_policy_in_text = num_policy_in_text + 1;
          });
        };
      })(this));
      svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + this.height + ")").call(xAxis);
      svg.append("g").attr("class", "y axis").call(yAxis);
      canvas.append("text").attr("transform", "translate(0,30) rotate(-90)").attr("y", 10).attr("dy", ".71em").style("text-anchor", "end").text("Average Connections");
      return svg.append("text").attr("x", this.width / 2).attr("y", 0 - (this.margin.top / 2)).attr("text-anchor", "middle").attr("class", "chart-title").text(this.curregion);
    };

    return WsConnectionsChart;

  })();

  ServerConnectionsChart = (function() {
    function ServerConnectionsChart(w, h, parent, title, evDispatch) {
      if (parent == null) {
        parent = "body";
      }
      if (title == null) {
        title = "";
      }
      this.margin = {
        top: 20,
        right: 60,
        bottom: 50,
        left: 60
      };
      this.width = w - this.margin.left - this.margin.right;
      this.height = h - this.margin.top - this.margin.bottom;
      this.parent = parent;
      this.allbudata = null;
      this.title = title;
      this.evDispatch = evDispatch;
      this.curregion = "headquarters";
      this.policystatus = ["file_server", "multiple"];
    }

    ServerConnectionsChart.prototype.load = function(data) {
      var dateFormat;
      this.allbudata = data;
      dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
      return this.allbudata.forEach(function(d) {
        return d.timestamp = dateFormat.parse(d.healthtime);
      });
    };

    ServerConnectionsChart.prototype.draw = function(region) {
      var button, canvas, color_scale, data, svg, x, xAxis, y, yAxis;
      if (region == null) {
        region = "headquarters";
      }
      this.curregion = region;
      color_scale = d3.scale.category10().domain(["file_server", "multiple", "email", "compute", "web"]);
      button = d3.select(this.parent).selectAll("button").data(["file_server", "multiple", "email", "compute", "web"]).enter().append('button').attr("type", "button").attr({
        "class": "btn btn-xs",
        id: function(d) {
          return d;
        }
      }).style('background-color', function(d) {
        return color_scale(d);
      }).text(function(d) {
        return d;
      });
      button.on("click", (function(_this) {
        return function(d) {
          if (__indexOf.call(_this.policystatus, d) < 0) {
            _this.policystatus.push(d);
          } else {
            _this.policystatus = _this.policystatus.filter(function(val) {
              return d !== val;
            });
          }
          return _this.draw(_this.curregion);
        };
      })(this));
      data = this.allbudata.filter((function(_this) {
        return function(d) {
          return d.businessunit === region;
        };
      })(this));
      console.log(data);
      d3.select(this.parent).selectAll("svg").remove();
      canvas = d3.select(this.parent).append('svg').attr({
        width: this.width + this.margin.left + this.margin.right,
        height: this.height + this.margin.top + this.margin.bottom
      });
      svg = canvas.append('g').attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");
      x = d3.time.scale().range([0, this.width]);
      x.domain(d3.extent(data, function(d) {
        return d.timestamp;
      }));
      y = d3.scale.linear().range([this.height, 0]);
      y.domain([
        d3.min(data, (function(_this) {
          return function(d) {
            var s;
            return d3.min((function() {
              var _i, _len, _ref, _results;
              _ref = this.policystatus;
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                s = _ref[_i];
                _results.push(+d["" + s + "_avg_conn"]);
              }
              return _results;
            }).call(_this));
          };
        })(this)), d3.max(data, (function(_this) {
          return function(d) {
            var s;
            return d3.max((function() {
              var _i, _len, _ref, _results;
              _ref = this.policystatus;
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                s = _ref[_i];
                _results.push(+d["" + s + "_avg_conn"]);
              }
              return _results;
            }).call(_this));
          };
        })(this))
      ]);
      xAxis = d3.svg.axis().scale(x).orient("bottom");
      yAxis = d3.svg.axis().scale(y).orient("left");
      this.policystatus.forEach((function(_this) {
        return function(policystatus) {
          return svg.append("path").datum(data).attr("class", "line").attr({
            d: d3.svg.line().x(function(d) {
              return x(d.timestamp);
            }).y(function(d) {
              return y(+d["" + policystatus + "_avg_conn"]);
            }),
            stroke: color_scale(policystatus)
          });
        };
      })(this));
      svg.append('rect').attr({
        "class": 'overlay',
        width: this.width + this.margin.left + this.margin.right,
        height: this.height + this.margin.top + this.margin.bottom,
        fill: 'none',
        'pointer-events': 'all'
      });
      svg.on("mousemove", (function(_this) {
        return function() {
          var bisectDate, d, d0, d1, data_list, i, num_policy_in_text, tootltip_box, x0;
          x0 = x.invert(d3.mouse(d3.event.target)[0]);
          bisectDate = d3.bisector(function(d) {
            return d.timestamp;
          }).left;
          i = bisectDate(data, x0, 1);
          d0 = data[i - 1];
          d1 = data[i];
          d = x0 - d0.date > d1.date - x0 ? d1 : d0;
          data_list = data.filter(function(d) {
            return d.timestamp === d0.timestamp;
          });
          svg.select('#server_conn_tooltip_line').remove();
          svg.append('line').attr({
            x1: x(d.timestamp),
            y1: 0,
            x2: x(d.timestamp),
            y2: _this.height,
            stroke: 'green',
            'stroke-width': 2,
            id: 'server_conn_tooltip_line'
          });
          svg.select('#server_conn_data_id').remove();
          tootltip_box = svg.append('g').attr('id', 'server_conn_data_id');
          tootltip_box.append('text').text(d['healthtime']).attr('x', x(d.timestamp) + 10).attr('y', 30).attr('stroke', 'green').attr('stroke-width', 0.5);
          num_policy_in_text = 1;
          return _this.policystatus.forEach(function(policystatus) {
            tootltip_box.append('text').text("" + policystatus + ": " + d[policystatus + '_avg_conn']).attr('x', x(d.timestamp) + 10).attr('y', 30 + num_policy_in_text * 10).attr('stroke', 'green').attr('stroke-width', 0.5);
            return num_policy_in_text = num_policy_in_text + 1;
          });
        };
      })(this));
      svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + this.height + ")").call(xAxis);
      svg.append("g").attr("class", "y axis").call(yAxis);
      canvas.append("text").attr("transform", "translate(0,30) rotate(-90)").attr("y", 10).attr("dy", ".71em").style("text-anchor", "end").text("Average Connections");
      return svg.append("text").attr("x", this.width / 2).attr("y", 0 - (this.margin.top / 2)).attr("text-anchor", "middle").attr("class", "chart-title").text(this.curregion);
    };

    return ServerConnectionsChart;

  })();

  'use strict';

  DifferenceChart = (function() {
    function DifferenceChart(w, h, parent, title, evDispatch) {
      if (parent == null) {
        parent = "body";
      }
      if (title == null) {
        title = "";
      }
      this.margin = {
        top: 20,
        right: 40,
        bottom: 70,
        left: 70
      };
      this.width = w - this.margin.left - this.margin.right;
      this.height = h - this.margin.top - this.margin.bottom;
      this.parent = parent;
      this.data = null;
      this.title = title;
      this.evDispatch = evDispatch;
      this.curregion = "headquarters";
    }

    DifferenceChart.prototype.draw = function(region, data, start_time, end_time) {
      var area, canvas, dateFormat, legend, line, svg, x, xAxis, y, yAxis;
      if (region == null) {
        region = null;
      }
      if (data == null) {
        data = null;
      }
      if (start_time == null) {
        start_time = null;
      }
      if (end_time == null) {
        end_time = null;
      }
      if (region === null) {
        region = this.curregion;
      }
      this.curregion = region;
      data = data === null ? this.data : data;
      this.data = data;
      dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
      data = data.filter((function(_this) {
        return function(d) {
          return d.businessunit === region;
        };
      })(this));
      data.forEach((function(_this) {
        return function(d) {
          d.timestamp = dateFormat.parse(d.healthtime);
          d.expected = +d.expected;
          return d.reported = +d.reported;
        };
      })(this));
      data = data.filter((function(_this) {
        return function(d) {
          var _ref;
          if (start_time !== null && end_time !== null) {
            return (start_time <= (_ref = d.timestamp) && _ref <= end_time);
          } else {
            return true;
          }
        };
      })(this));
      if (data.length === 0) {
        return;
      }
      x = d3.time.scale().range([0, this.width]);
      y = d3.scale.linear().range([this.height, 0]);
      xAxis = d3.svg.axis().scale(x).orient("bottom");
      yAxis = d3.svg.axis().scale(y).orient("left");
      line = d3.svg.area().interpolate("step").x(function(d) {
        return x(d.timestamp);
      }).y(function(d) {
        return y(d.expected);
      });
      area = d3.svg.area().interpolate("step").x(function(d) {
        return x(d.timestamp);
      }).y(function(d) {
        return y(d.expected);
      });
      d3.select(this.parent).selectAll("svg").remove();
      canvas = d3.select(this.parent).append('svg').attr({
        width: this.width + this.margin.left + this.margin.right,
        height: this.height + this.margin.top + this.margin.bottom
      });
      svg = canvas.append('g').attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");
      x.domain(d3.extent(data, function(d) {
        return d.timestamp;
      }));
      y.domain([
        0, d3.max(data, function(d) {
          return Math.max(d.expected, d.reported);
        })
      ]);
      svg.datum(data);
      svg.append("path").attr("class", "area below").attr("d", area.y0(function(d) {
        if (d.expected >= d.reported) {
          return y(d.reported);
        } else {
          return y(0);
        }
      }).y1(function(d) {
        if (d.expected >= d.reported) {
          return y(d.expected);
        } else {
          return y(0);
        }
      }));
      svg.append("path").attr("class", "area above").attr("d", area.y0(function(d) {
        if (d.expected < d.reported) {
          return y(d.expected);
        } else {
          return y(0);
        }
      }).y1(function(d) {
        if (d.expected < d.reported) {
          return y(d.reported);
        } else {
          return y(0);
        }
      }));
      svg.append("path").attr("class", "line").attr("d", line);
      svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + this.height + ")").call(xAxis);
      svg.append("g").attr("class", "y axis").call(yAxis);
      canvas.append("text").attr("transform", "translate(0,30) rotate(-90)").attr("y", 10).attr("dy", ".71em").style("text-anchor", "end").text("Machine Count");
      svg.append("text").attr("x", this.width / 2).attr("y", 0 - (this.margin.top / 2)).attr("text-anchor", "middle").attr("class", "chart-title").text(this.title);
      legend = svg.append('g');
      legend.append("text").attr("x", this.width / 2).attr("y", this.height + (this.margin.bottom / 2) + 5).attr("class", "legend").style({
        stroke: "red",
        "stroke-width": "1px"
      }).text("Down but should be up");
      return legend.append("text").attr("x", this.width / 2).attr("y", this.height + (this.margin.bottom / 2) + 15).attr("class", "legend").style("stroke", "#118bff").text("Up but should be Down");
    };

    return DifferenceChart;

  })();

  MultiLineChart = (function() {
    function MultiLineChart(w, h, parent, title, evDispatch) {
      if (parent == null) {
        parent = "body";
      }
      if (title == null) {
        title = "";
      }
      this.margin = {
        top: 20,
        right: 20,
        bottom: 70,
        left: 50
      };
      this.width = w - this.margin.left - this.margin.right;
      this.height = h - this.margin.top - this.margin.bottom;
      this.parent = parent;
      this.data = null;
      this.title = title;
      this.evDispatch = evDispatch;
      this.curregion = "headquarters";
    }

    MultiLineChart.prototype.draw = function(region, data, start_time, end_time) {
      var canvas, dateFormat, line, svg, workzone, x, xAxis, y, yAxis;
      if (region == null) {
        region = null;
      }
      if (data == null) {
        data = null;
      }
      if (start_time == null) {
        start_time = null;
      }
      if (end_time == null) {
        end_time = null;
      }
      if (region === null) {
        region = this.curregion;
      }
      this.curregion = region;
      data = data === null ? this.data : data;
      this.data = data;
      dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
      data = data.filter((function(_this) {
        return function(d) {
          return d.businessunit === region;
        };
      })(this));
      data.forEach(function(d) {
        d.timestamp = dateFormat.parse(d.healthtime);
        d.expected = +d.expected;
        return d.reported = +d.reported;
      });
      data = data.filter((function(_this) {
        return function(d) {
          var _ref;
          if (start_time !== null && end_time !== null) {
            return (start_time <= (_ref = d.timestamp) && _ref <= end_time);
          } else {
            return true;
          }
        };
      })(this));
      x = d3.time.scale().range([0, this.width]);
      y = d3.scale.linear().range([this.height, 0]);
      xAxis = d3.svg.axis().scale(x).orient("bottom");
      yAxis = d3.svg.axis().scale(y).orient("left");
      line = d3.svg.area().interpolate("basis").x(function(d) {
        return x(new Date(d.timestamp.getTime() - +d.lag * 60 * 60 * 1000));
      }).y(function(d) {
        return y(+d.avgconn);
      });
      workzone = d3.svg.area().interpolate("basis").x(function(d) {
        return x(d.timestamp);
      }).y((function(_this) {
        return function(d) {
          var time;
          time = new Date(d.timestamp.getTime() - d.lag * 60 * 60 * 1000);
          if (time.getHours() >= 7 && time.getHours() < 18) {
            return 0;
          } else {
            return _this.height;
          }
        };
      })(this));
      d3.select(this.parent).selectAll("svg").remove();
      canvas = d3.select(this.parent).append('svg').attr({
        width: this.width + this.margin.left + this.margin.right,
        height: this.height + this.margin.top + this.margin.bottom
      });
      svg = canvas.append('g').attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");
      x.domain(d3.extent(data, function(d) {
        return new Date(d.timestamp.getTime() - +d.lag * 60 * 60 * 1000);
      }));
      y.domain(d3.extent(data, function(d) {
        return +d.avgconn;
      }));
      svg.append("path").datum(data).attr("class", "line").attr("d", line);
      svg.datum(data).append("path").attr("fill", "red").attr("d", workzone);
      svg.append("g").attr("class", "x axis").attr("transform", "translate(0," + this.height + ")").call(xAxis);
      svg.append("g").attr("class", "y axis").call(yAxis).append("text").attr("transform", "rotate(-90)").attr("y", 6).attr("dy", ".71em").style("text-anchor", "end");
      canvas.append("text").attr("transform", "translate(0,30) rotate(-90)").attr("y", 10).attr("dy", ".71em").style("text-anchor", "end").text("Average Connections");
      return svg.append("text").attr("x", this.width / 2).attr("y", 0 - (this.margin.top / 2)).attr("text-anchor", "middle").attr("class", "chart-title").text(this.title);
    };

    return MultiLineChart;

  })();

  BWDashboard = (function() {
    function BWDashboard(parent) {
      if (parent == null) {
        parent = "body";
      }
      this.setupEventDispatch();
      this.setupPlots();
      this.loadData();
    }

    BWDashboard.prototype.setupEventDispatch = function() {
      return this.evdispatch = d3.dispatch("load", "selectRegion", "selectTime", "attime");
    };

    BWDashboard.prototype.setupPlots = function() {
      this.bw_map_selector = new BWMap(400, 300, "#bw_map_selector", this.evdispatch);
      this.evdispatch.on("attime.map", (function(_this) {
        return function(time) {
          return _this.bw_map_selector.draw(time);
        };
      })(this));
      this.bw_map_selector.load();
      this.bw_map_for_spread = new BWMapVirus(400, 300, "#bw_map_for_spread", this.evdispatch);
      this.evdispatch.on("attime.mapspread", (function(_this) {
        return function(time) {
          return _this.bw_map_for_spread.draw(time);
        };
      })(this));
      this.bw_map_for_spread.load();
      this.bw_ws_reported_chart = new DifferenceChart(560, 200, "#bw_ws_reported_chart", "Expected vs Reported Workstations");
      this.bw_server_reported_chart = new DifferenceChart(560, 200, "#bw_server_reported_chart", "Expected vs Reported Servers");
      this.bw_atm_reported_chart = new DifferenceChart(560, 200, "#bw_atm_reported_chart", "Expected vs Reported ATM");
      this.evdispatch.on("selectRegion.ws", (function(_this) {
        return function(region) {
          return _this.bw_ws_reported_chart.draw(region);
        };
      })(this));
      this.evdispatch.on("selectTime.ws", (function(_this) {
        return function(start, end) {
          return _this.bw_ws_reported_chart.draw(null, null, start, end);
        };
      })(this));
      this.evdispatch.on("selectRegion.server", (function(_this) {
        return function(region) {
          return _this.bw_server_reported_chart.draw(region);
        };
      })(this));
      this.evdispatch.on("selectTime.server", (function(_this) {
        return function(start, end) {
          return _this.bw_server_reported_chart.draw(null, null, start, end);
        };
      })(this));
      this.evdispatch.on("selectRegion.atm", (function(_this) {
        return function(region) {
          return _this.bw_atm_reported_chart.draw(region);
        };
      })(this));
      this.evdispatch.on("selectTime.atm", (function(_this) {
        return function(start, end) {
          return _this.bw_atm_reported_chart.draw(null, null, start, end);
        };
      })(this));
      this.bw_ws_conn_chart = new WsConnectionsChart(760, 200, "#bw_ws_conn_chart", "WS Connections");
      this.evdispatch.on("selectRegion.bw_ws_conn_chart", (function(_this) {
        return function(region) {
          return _this.bw_ws_conn_chart.draw(region);
        };
      })(this));
      this.evdispatch.on("selectTime.bw_ws_conn_chart", (function(_this) {
        return function(start, end) {
          return _this.bw_ws_conn_chart.draw(null);
        };
      })(this));
      this.bw_server_conn_chart = new ServerConnectionsChart(760, 200, "#bw_server_conn_chart", "Server Connections");
      this.evdispatch.on("selectRegion.bw_server_conn_chart", (function(_this) {
        return function(region) {
          return _this.bw_server_conn_chart.draw(region);
        };
      })(this));
      this.evdispatch.on("selectTime.bw_server_conn_chart", (function(_this) {
        return function(start, end) {
          return _this.bw_server_conn_chart.draw(null);
        };
      })(this));
      this.bw_policy_chart = new MultiTimeSeriesPolicyChart(760, 200, "#bw_policy_chart", "Policy & Activity Flag", this.evdispatch);
      this.evdispatch.on("selectRegion.policy", (function(_this) {
        return function(region) {
          return _this.bw_policy_chart.draw(region);
        };
      })(this));
      $("#slider-range").slider({
        range: true,
        min: 0,
        max: 192,
        step: 1,
        values: [0, 192],
        slide: (function(_this) {
          return function(event, ui) {
            var dateFormat, end_date, start_date;
            dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
            start_date = new Date(dateFormat.parse("2012-02-02 08:00:00").getTime() + +ui.values[0] * 60000 * 15);
            end_date = new Date(dateFormat.parse("2012-02-04 08:00:00").getTime() - (192 - +ui.values[1]) * 60000 * 15);
            $("#start_time").attr("value", start_date.toString());
            $("#end_time").attr("value", end_date.toString());
            return _this.evdispatch.selectTime(start_date, end_date);
          };
        })(this)
      });
      return $("#timeslider").slider({
        range: "max",
        min: 0,
        max: 192,
        step: 1,
        value: 0,
        slide: (function(_this) {
          return function(event, ui) {
            var dateFormat, start_date;
            dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
            start_date = new Date(dateFormat.parse("2012-02-02 08:00:00").getTime() + +ui.value * 60000 * 15);
            $("#attime").val(start_date.toString());
            return _this.evdispatch.attime(start_date);
          };
        })(this)
      });
    };

    BWDashboard.prototype.loadData = function() {
      d3.csv('/static/csv/ws_teller_report_status.csv', (function(_this) {
        return function(error, data) {
          return _this.bw_ws_reported_chart.draw("headquarters", data);
        };
      })(this));
      d3.csv('/static/csv/server_report_status.csv', (function(_this) {
        return function(error, data) {
          return _this.bw_server_reported_chart.draw("headquarters", data);
        };
      })(this));
      d3.csv('/static/csv/atm_report_status.csv', (function(_this) {
        return function(error, data) {
          return _this.bw_atm_reported_chart.draw("headquarters", data);
        };
      })(this));
      d3.csv('/static/csv/ws_connection_new.csv', (function(_this) {
        return function(error, data) {
          _this.bw_ws_conn_chart.load(data);
          return _this.bw_ws_conn_chart.draw("headquarters", data);
        };
      })(this));
      d3.csv('/static/csv/server_connection_new.csv', (function(_this) {
        return function(error, data) {
          _this.bw_server_conn_chart.load(data);
          return _this.bw_server_conn_chart.draw("headquarters", data);
        };
      })(this));
      return d3.csv('/static/csv/overall_policy_activity_status_new.csv', (function(_this) {
        return function(error, data) {
          _this.bw_policy_chart.load(data);
          return _this.bw_policy_chart.draw("headquarters");
        };
      })(this));
    };

    return BWDashboard;

  })();

  b = new BWDashboard();

}).call(this);
